# kafka 生产者客户端的知识

## 发送消息的方式

kafka 消息发送有同步（sync）、异步（async）两种，以及三种消息确认方式。

kafka 的客户端，会将消息 producerRecord 先放入到缓存与队列中，缓存到某个数量或者占用内存大小才会发送，所以不需要特别进行批量处理，性能是有保证的。
这些 kafka 客户端已经帮助封装好了。

发送的时候如果不指定分区，或者未设置 key，将会放到 topic 下随机的分区下。如果设置了 key，将会把 key 进行 hash 后，按规则放到某个分区下。
所以如果分区数不变的话，消息进入的分区是不变的。建议如果想放到某个固定分区的话，设置自定义的分区器。

## 提高吞吐率

为了提高吞吐率，可以提高 broker 和 topic 的数量。

如果不追求消息百分百投递成功，可以设置 `producer.acks=0 或 1`。

> 吞吐率与消息的完整率是互斥的，提高吞吐率的同时，必然会导致消息丢失可能性的增加。

## 百分百保证准确投递

- 设置 `producer.acks=-1 或 all`。表示一定得分区的全部 replicas 都同步完成后，才确认记录。

- 给 topic 设置 replication.factor 参数：这个值必须大于 1，要求每个 partition 必须有至少 2 个副本。

- 在 Kafka 服务端设置 `min.insync.replicas` 参数：这个值必须大于 1，
这个是要求一个 leader 至少感知到有至少一个 follower 还跟自己保持联系，没掉队，这样才能确保 leader 挂了还有一个 follower。

- 了解每条写入数据的大小，避免数据过大超过限制。

- 异步发送消息，如果 ack 一直没有或者数据过多，导致缓冲池满了，会丢失消息。可使用同步。

- 重试次数增大。

- 同步发送。

